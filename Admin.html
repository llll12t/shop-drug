<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-100 min-h-screen p-6">
  <div class="max-w-md m-auto">
    <div class="mb-4">
      <!-- Sort Field -->
      <div class="flex justify-between">
        <h1 class="text-md font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <select id="filter-sort" class="border px-2 py-1 rounded-md">
          <option value="desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
          <option value="asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <div id="data-table-container" class="overflow-x-auto">
      <table id="data-table" class="min-w-full border-collapse text-sm">
        <thead class="bg-blue-900 text-white text-sm">
          <tr>
            <th class="px-4 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th class="px-4 py-2 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
            <th class="px-4 py-2 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="px-4 py-2 text-left">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th>
          </tr>
        </thead>
        <tbody id="data-tbody" class="bg-white">
          <!-- ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JS -->
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center mt-4"></div>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." -->
    <div id="loading-message" class="text-center text-gray-100 mb-4" style="display: none;">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...
    </div>
  </div>

  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Express, TAX ‡πÅ‡∏•‡∏∞ SEND -->
  <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded-md w-full max-w-md">
      <h2 class="text-xl mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á, ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏, ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>
      <form id="edit-form">
        <input type="hidden" id="edit-order-id">
        <div class="mb-4">
          <label for="edit-express" class="block text-sm">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
          <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏á" -->
          <select id="edit-express" class="w-full border px-2 py-1 rounded-md">
            <option value="kerry">Kerry</option>
            <option value="flash">Flash</option>
            <option value="thaipost">ThaiPost</option>
            <option value="‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏á">‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏á</option>
            <option value="Pre-Order">Pre-Order</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="edit-tax" class="block text-sm">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ / TAX</label>
          <!-- placeholder ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°" -->
          <input type="text" id="edit-tax" class="w-full border px-2 py-1 rounded-md" placeholder="‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°">
        </div>
        <div class="mb-4">
          <label for="edit-send" class="block text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
          <input type="datetime-local" id="edit-send" class="w-full border px-2 py-1 rounded-md">
        </div>
        <div class="flex justify-end">
          <button type="button" class="bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-700 mr-2"
            onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-700">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Script -->
  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyGHiBqDs2u5nPkI5Lds4l0G_obNwHMyQw87ZXkF07Pva0QEkWHRrNWXR7lKu37ikXyxw/exec';
    const ROWS_PER_PAGE = 10;
    let currentPage = 1;
    let tableData = [];
    let filteredData = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    window.onload = fetchData;
    async function fetchData() {
      document.getElementById('loading-message').style.display = 'block';
      try {
        const response = await fetch(WEB_APP_URL);
        const data = await response.json();
        // processOrders() ‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á citizenid ‡∏à‡∏≤‡∏Å index 4
        tableData = processOrders(data.slice(1));
        filteredData = tableData;
        applyFilters();
      } catch (error) {
        console.error('Error fetching data:', error);
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
      } finally {
        document.getElementById('loading-message').style.display = 'none';
      }
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á citizenid
    function processOrders(data) {
      const processedData = [];
      const orderMap = {};

      data.forEach(row => {
        // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà:
        // [0]=orderId, [1]=name, [2]=address, [3]=contact, [4]=citizenid, [5]=note, [6]=userlineid,
        // [7]=productId, [8]=productName, [9]=price, [10]=size, [11]=quantity, [12]=itemTotal, [13]=timestamp,
        // [14]=paymentStatus, [15]=express, [16]=tax, [17]=send
        const orderId = row[0];
        const totalOrder = parseFloat(row[11]) || 0;
        const totalPrice = parseFloat(row[11]) || 0;
        const rawTimestamp = row[12];
        const timestamp = new Date(rawTimestamp);
        const paymentStatus = row[13] || '';
        const express = row[14] || '';
        const tax = row[15] || '';
        const send = row[16] ? formatDate(row[16]) : '';

        if (!orderMap[orderId]) {
          orderMap[orderId] = {
            orderId: orderId,
            name: row[1],
            address: row[2],
            contact: row[3],
            note: row[4],
            userlineid: row[5],
            totalOrder: totalOrder,
            totalPrice: totalPrice,
            timestamp: timestamp,
            paymentStatus: paymentStatus,
            express: express,
            tax: tax,
            send: send,
            products: []
          };
        } else {
          orderMap[orderId].totalOrder += totalOrder;
          orderMap[orderId].totalPrice += totalPrice;
        }

        orderMap[orderId].products.push({
          idProduct: row[7],
          product: row[8],
          price: parseFloat(row[9]),
          size: row[10],
          quantity: parseInt(row[11]),
          value: parseFloat(row[12])
        });
      });

      for (let orderId in orderMap) {
        processedData.push(orderMap[orderId]);
      }
      return processedData;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    function getStatusEmoji(status) {
      if (status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') {
        return '‚úÖ';
      } else if (!status) {
        return '‚ö†Ô∏è';
      } else if (status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤') {
        return '‚ùå';
      } else if (status === '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß') {
        return '‚ùå';
      } else {
        return status; 
      }
    }

    // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á + ‡πÅ‡∏™‡∏î‡∏á
    function applyFilters() {
      const sortValue = document.getElementById('filter-sort').value;
      filteredData.sort((a, b) => sortValue === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp);
      currentPage = 1;
      displayData(filteredData);
      renderPagination(filteredData.length);
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function displayData(data) {
      const tbody = document.getElementById('data-tbody');
      tbody.innerHTML = '';

      const start = (currentPage - 1) * ROWS_PER_PAGE;
      const end = start + ROWS_PER_PAGE;
      const paginatedData = data.slice(start, end);

      paginatedData.forEach(order => {
        const mainRow = document.createElement('tr');
        mainRow.className = 'border-b';

        // (1) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const dateCell = document.createElement('td');
        dateCell.className = 'px-4 py-2';
        dateCell.textContent = formatDate(order.timestamp);

        // (2) ‡∏ä‡∏∑‡πà‡∏≠
        const nameCell = document.createElement('td');
        nameCell.className = 'px-4 py-2';
        nameCell.textContent = order.name;

        // (3) ‡∏£‡∏≤‡∏Ñ‡∏≤
        const priceCell = document.createElement('td');
        priceCell.className = 'px-4 py-2';
        priceCell.textContent = `${order.totalPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;

        // (4) ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusCell = document.createElement('td');
        statusCell.className = 'px-4 py-2';
        statusCell.textContent = getStatusEmoji(order.paymentStatus);

        // (5) ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
        const commandCell = document.createElement('td');
        commandCell.className = 'px-4 py-2 text-center';
        const commandButton = document.createElement('button');
        commandButton.textContent = 'üìù';
        commandButton.className = 'bg-blue-900 text-white py-1 px-3 rounded-md hover:bg-orange-700';
        commandButton.onclick = () => toggleDetailRow(`detail-${order.orderId}`);
        commandCell.appendChild(commandButton);

        mainRow.appendChild(dateCell);
        mainRow.appendChild(nameCell);
        mainRow.appendChild(priceCell);
        mainRow.appendChild(statusCell);
        mainRow.appendChild(commandCell);
        tbody.appendChild(mainRow);

        // Detail row
        const detailRow = document.createElement('tr');
        detailRow.id = `detail-${order.orderId}`;
        detailRow.className = 'border-b hidden';
        const detailCell = document.createElement('td');
        detailCell.colSpan = 5;
        detailCell.className = 'px-4 py-2 bg-gray-50';

        let btnHtml = `
          <div class="flex flex-wrap gap-2">
            <button class="bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-700" onclick="showDetails('${order.orderId}')">
              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>
            <button class="bg-yellow-500 text-white py-1 px-3 rounded-md hover:bg-yellow-700" onclick="openEditModal('${order.orderId}')">
              ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á
            </button>
        `;
        const isPaid = (order.paymentStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        btnHtml += `
            <button class="bg-gray-800 text-white py-1 px-3 rounded-md hover:bg-gray-600 ${isPaid ? 'opacity-50 cursor-not-allowed' : ''}"
              ${isPaid ? 'disabled' : ''}
              onclick="if(!${isPaid}) { openPaymentOptions('${order.orderId}'); }">
              ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </button>
          </div>
        `;
        detailCell.innerHTML = btnHtml;
        detailRow.appendChild(detailCell);
        tbody.appendChild(detailRow);
      });
    }

    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á detail row
    function toggleDetailRow(id) {
      document.getElementById(id).classList.toggle('hidden');
    }

    // Pagination
    function renderPagination(totalRows) {
      const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      const maxPages = 3;
      let startPage = Math.max(1, currentPage - 1);
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      if (endPage - startPage < maxPages - 1) startPage = Math.max(1, endPage - maxPages + 1);

      if (startPage > 1) {
        const prevButton = document.createElement('button');
        prevButton.className = 'mx-1 px-3 py-1 bg-gray-300 rounded-md';
        prevButton.innerText = 'Prev';
        prevButton.onclick = () => { currentPage = startPage - 1; displayData(filteredData); renderPagination(totalRows); };
        pagination.appendChild(prevButton);
      }

      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `mx-1 px-3 py-1 rounded-md ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-300'}`;
        pageButton.innerText = i;
        pageButton.onclick = () => { currentPage = i; displayData(filteredData); renderPagination(totalRows); };
        pagination.appendChild(pageButton);
      }

      if (endPage < totalPages) {
        const nextButton = document.createElement('button');
        nextButton.className = 'mx-1 px-3 py-1 bg-gray-300 rounded-md';
        nextButton.innerText = 'Next';
        nextButton.onclick = () => { currentPage = endPage + 1; displayData(filteredData); renderPagination(totalRows); };
        pagination.appendChild(nextButton);
      }
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô dd/MM/yyyy HH:mm
    function formatDate(isoInput) {
      const date = new Date(isoInput);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ current datetime ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö datetime-local
    function getCurrentDateTimeLocal() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å dd/MM/yyyy HH:mm ‡πÄ‡∏õ‡πá‡∏ô datetime-local
    function convertToDateTimeLocal(dateString) {
      const [day, month, year, hours, minutes] = dateString.split(/[/\s:]/);
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (SweetAlert) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á citizenid
    function showDetails(orderId) {
      const order = tableData.find(o => o.orderId === orderId);
      if (!order) {
        Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Order ID: ${orderId}` });
        return;
      }
      let htmlDetail = `
        <div style="margin-bottom: 10px; font-size:14px; text-align: start;">
          <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</strong>
          <p><strong>Order ID:</strong> ${order.orderId}</p>
          <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á:</strong> ${order.name}</p>
          <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${order.address}</p>
          <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> ${order.contact}</p>
          <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${order.note}</p>
        </div>
        <div style="margin-bottom: 10px; font-size:14px; text-align: start;">
          <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</strong>
        </div>
      `;
      order.products.forEach(prod => {
        htmlDetail += `
          <div style="margin-bottom: 10px;font-size:14px;text-align: start;">
            <div style="display: flex; justify-content: space-between;">
              <div style="flex: 1; padding-right: 10px;">
                <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${prod.product}</p>
                <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ${prod.price} ‡∏ö‡∏≤‡∏ó</p>
              </div>
              <div style="flex: 1; padding-left: 10px;">
                <p><strong>‡πÑ‡∏ã‡∏ï‡πå:</strong> ${prod.size}</p>
                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${prod.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</p>
              </div>
            </div>
          </div>
        `;
      });
      htmlDetail += `
        <div style="margin-top: 20px; font-size:14px; text-align: start;">
          <strong>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${order.totalPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó
        </div>
        <div style="margin-top: 10px; font-size:14px; text-align: start;">
          <strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</strong> ${formatDate(order.timestamp)}
        </div>
      `;
      Swal.fire({
        title: `<div class="text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏• Order ${order.orderId}</div>`,
        html: htmlDetail,
        confirmButtonText: '‡∏õ‡∏¥‡∏î'
      });
    }

    // Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Express, TAX ‡πÅ‡∏•‡∏∞ SEND
    function openEditModal(orderId) {
      const order = tableData.find(o => o.orderId === orderId);
      if (!order) {
        Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Order ID: ${orderId}` });
        return;
      }
      document.getElementById('edit-order-id').value = order.orderId;
      document.getElementById('edit-express').value = order.express;
      document.getElementById('edit-tax').value = order.tax;
      document.getElementById('edit-send').value = order.send ? convertToDateTimeLocal(order.send) : getCurrentDateTimeLocal();
      document.getElementById('edit-modal').classList.remove('hidden');
    }

    document.getElementById('edit-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const orderId = document.getElementById('edit-order-id').value;
      const express = document.getElementById('edit-express').value;
      const tax = document.getElementById('edit-tax').value;
      const send = document.getElementById('edit-send').value;
      if (!orderId) {
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö Order ID' });
        return;
      }
      await updateData(orderId, express, tax, send);
      closeModal();
    });

    async function updateData(orderId, express, tax, send) {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `method=updateOrderData&orderId=${encodeURIComponent(orderId)}&express=${encodeURIComponent(express)}&tax=${encodeURIComponent(tax)}&send=${encodeURIComponent(send)}`
        });
        const result = await response.text();
        Swal.fire({
          title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: result,
          icon: 'success',
          confirmButtonText: 'OK'
        });
        fetchData();
      } catch (error) {
        console.error('Error updating data:', error);
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
      }
    }

    function closeModal() {
      document.getElementById('edit-modal').classList.add('hidden');
    }

    // ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    function openPaymentOptions(orderId) {
      Swal.fire({
        title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
        input: 'radio',
        inputOptions: {
          '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à': '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
        },
        inputValidator: (value) => { if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô!'; },
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
          });
          updatePaymentStatus(orderId, result.value);
        }
      });
    }
    function updatePaymentStatus(orderId, paymentMethod) {
      $.post(WEB_APP_URL, {
        method: 'updateOrderData',
        orderId: orderId,
        payment: paymentMethod
      }, function (response) {
        Swal.fire({
          icon: 'success',
          title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Order ID: ${orderId} ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô ${paymentMethod}`
        });
        fetchData();
      }).fail(function () {
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'
        });
      });
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ sort
    document.getElementById('filter-sort').addEventListener('change', applyFilters);
  </script>
</body>
</html>
